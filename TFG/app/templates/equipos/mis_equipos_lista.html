{% extends 'base.html' %}
{% load static %}

{% block title %}{{ titulo_pagina }} - De Rabona{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/equipo/lista_equipo_styles.css' %}">
<style>
    .equipo-card.inactive {
        opacity: 0.6;
        border-left: 4px solid #6b7280; 
    }
    .equipo-card.inactive:hover {
        opacity: 0.8;
    }
    .admin-badge {
        position: absolute;
        top: 1rem;
        left: 1rem;
        font-size: 0.75rem;
        font-weight: 500;
        padding: 0.3rem 0.6rem;
        border-radius: 6px;
        z-index: 2;
    }
    .badge-activo { background-color: rgba(16, 185, 129, 0.8); color: white; }
    .badge-inactivo { background-color: rgba(107, 114, 128, 0.8); color: white; }
</style>
{% endblock %}

{% block content %}
<div class="equipos-container">
    <!-- Hero Section -->
    <div class="equipos-hero-section animate-in">
        <div class="hero-content">
            <div class="hero-icon">
                <i class="fas fa-users"></i>
            </div>
            <div class="hero-text">
                <h1 class="hero-title">{{ titulo_pagina }}</h1>
                <p class="hero-subtitle">Gestiona y visualiza todos tus equipos</p>
            </div>
        </div>
        
        <div class="header-actions">
            <a href="{% url 'crear_equipo_permanente' %}" class="btn btn-primary">
                <i class="fas fa-plus-circle"></i>
                <span>Crear Nuevo Equipo</span>
            </a>
        </div>
    </div>

    <!-- Mensajes del Sistema -->
    {% if messages %}
        <div class="messages-section">
            {% for message in messages %}
                <div class="custom-alert alert-{{ message.tags }}">
                    <div class="alert-icon">
                        <i class="fas fa-{% if message.tags == 'success' %}check-circle{% elif message.tags == 'error' or message.tags == 'danger' %}exclamation-triangle{% elif message.tags == 'warning' %}exclamation-circle{% else %}info-circle{% endif %}"></i>
                    </div>
                    <div class="alert-content">{{ message }}</div>
                    <button type="button" class="alert-dismiss" onclick="this.parentElement.remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            {% endfor %}
        </div>
    {% endif %}

    {% if equipos_list %}
        <!-- Estadísticas rápidas -->
        <div class="stats-section">
            <div class="stats-grid">
                <div class="stat-card animate-in">
                    <div class="stat-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number">{{ equipos_list|length }}</div>
                        <div class="stat-label">Equipo{{ equipos_list|length|pluralize }}</div>
                    </div>
                </div>             
            </div>
        </div>

        <!-- Lista de Equipos -->
        <div class="equipos-section">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="fas fa-shield-alt"></i>
                    Mis Equipos
                </h2>
                <div class="section-meta">
                    <div class="equipos-count">
                        {{ equipos_list|length }} equipos encontrados
                    </div>
                </div>
            </div>
            
            <div class="equipos-grid">
                {% for equipo in equipos_list %}
                <!-- El bucle empieza aquí, con la tarjeta principal -->
                <div class="equipo-card animate-in" data-equipo-id="{{ equipo.id_equipo }}">
                    
                    <!-- Banner del equipo -->
                    <div class="equipo-image">
                        <img src="{{ equipo.get_banner_url }}" alt="Banner de {{ equipo.nombre_equipo }}" class="equipo-img">
                        
                        <div class="image-overlay">
                            <h3 class="equipo-title">{{ equipo.nombre_equipo }}</h3>
                        </div>
                        {% if is_admin_view %}
                            {% if equipo.activo %}
                                <div class="admin-badge badge-activo">Activo</div>
                            {% else %}
                                <div class="admin-badge badge-inactivo">Inactivo</div>
                            {% endif %}
                        {% endif %}

                        {% if equipo.capitan == request.user %}
                            <div class="equipo-badge">
                                <i class="fas fa-crown"></i>
                                Capitán
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- Contenido del equipo -->
                    <div class="equipo-content">
                        <!-- Header con escudo y descripción -->
                        <div class="equipo-header">
                            <div class="escudo-container">
                                    <img src="{{ equipo.get_shield_url }}" alt="Escudo {{ equipo.nombre_equipo }}" class="escudo-image">
                            </div>
                            <div class="equipo-info">
                                <p class="equipo-description">{{ equipo.descripcion|truncatewords:15|default:"Sin descripción disponible." }}</p>
                            </div>
                        </div>
                        
                        <!-- Información del equipo -->
                        <div class="equipo-details">
                            <div class="info-item">
                                <div class="info-icon">
                                    <i class="fas fa-user-shield"></i>
                                </div>
                                <div class="info-text">{{ equipo.capitan.nombre }}</div>
                            </div>
                            
                            <div class="info-item">
                                <div class="info-icon">
                                    <i class="fas fa-users"></i>
                                </div>
                                <div class="info-text">{{ equipo.jugadores.count }} jugador{{ equipo.jugadores.count|pluralize:"es" }}</div>
                            </div>
                            
                            <div class="info-item">
                                <div class="info-icon">
                                    <i class="fas fa-calendar-alt"></i>
                                </div>
                                <div class="info-text">Creado {{ equipo.fecha_creacion|date:"M Y" }}</div>
                            </div>
                        </div>
                        
                        <!-- Acciones del equipo -->
                        <div class="equipo-actions">
                            <a href="{% url 'detalle_equipo' pk=equipo.id_equipo %}" class="btn btn-primary">
                                <i class="fas fa-eye"></i>
                                Ver Detalles
                            </a>
                            <div class="dropdown">
                                <button class="btn btn-secondary" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    {% if equipo.capitan == request.user %}
                                        <!-- Acciones para el CAPITÁN -->
                                        <li>
                                            <a class="dropdown-item" href="{% url 'editar_equipo_permanente' pk=equipo.id_equipo %}">
                                                <i class="fas fa-edit"></i>Editar Equipo
                                            </a>
                                        </li>
                                        <li>
                                            <a class="dropdown-item" href="{% url 'gestionar_miembros' pk=equipo.id_equipo %}">
                                                <i class="fas fa-users-cog"></i>Gestionar Miembros
                                            </a>
                                        </li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li>
                                            <a class="dropdown-item text-danger" href="{% url 'eliminar_equipo' pk=equipo.id_equipo %}">
                                                <i class="fas fa-trash"></i>Eliminar Equipo
                                            </a>
                                        </li>
                                    {% else %}
                                        <!-- Acción para MIEMBROS -->
                                        <li>
                                            <form method="post" action="{% url 'abandonar_equipo' pk=equipo.id_equipo %}" onsubmit="return confirm('¿Estás seguro de que quieres abandonar el equipo {{ equipo.nombre_equipo }}?');" class="dropdown-item p-0">
                                                {% csrf_token %}
                                                <button type="submit" class="btn btn-link dropdown-item text-danger w-100 text-start">
                                                    <i class="fas fa-sign-out-alt"></i>Abandonar Equipo
                                                </button>
                                            </form>
                                        </li>
                                    {% endif %}

                                    {% if is_admin_view %}
                                        <li><hr class="dropdown-divider"></li>
                                        <li>
                                            <form action="{% url 'toggle_activo_equipo' pk=equipo.pk %}" method="post" class="dropdown-item p-0">
                                                {% csrf_token %}
                                                <button type="submit" class="btn btn-link dropdown-item w-100 text-start">
                                                    {% if equipo.activo %}
                                                        <i class="fas fa-toggle-off"></i> Desactivar Equipo
                                                    {% else %}
                                                        <i class="fas fa-toggle-on"></i> Activar Equipo
                                                    {% endif %}
                                                </button>
                                            </form>
                                        </li>
                                    {% endif %}
                                </ul>
                            </div>
                        </div>
                    </div>

                </div>
                {% endfor %}
            </div>
        </div>

    {% else %}
        <!-- Estado vacío -->
        <div class="empty-state animate-in">
            <div class="empty-icon">
                <i class="fas fa-users-slash"></i>
            </div>
            <div class="empty-content">
                <h2 class="empty-title">No tienes equipos todavía</h2>
                <p class="empty-desc">
                    Parece que aún no perteneces ni capitaneas ningún equipo permanente.<br>
                    ¡Es el momento perfecto para crear tu primer equipo!
                </p>
                <div class="empty-actions">
                    <a href="{% url 'crear_equipo_permanente' %}" class="btn btn-primary">
                        <i class="fas fa-plus-circle"></i>
                        Crear Mi Primer Equipo
                    </a>
                    
                </div>
                
                <!-- Sugerencias -->
                <div class="suggestions">
                    <h3 class="suggestions-title">¿Qué puedes hacer con un equipo?</h3>
                    <div class="suggestions-grid">
                        <div class="suggestion-item">
                            <i class="fas fa-calendar-check"></i>
                            <span>Organizar partidos</span>
                        </div>
                        <div class="suggestion-item">
                            <i class="fas fa-chart-line"></i>
                            <span>Seguir estadísticas</span>
                        </div>
                        <div class="suggestion-item">
                            <i class="fas fa-trophy"></i>
                            <span>Crear retos de equipo</span>
                        </div>
                        <div class="suggestion-item">
                            <i class="fas fa-users"></i>
                            <span>Ser incluido en tabla clasificatoria global</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/equipo/lista_equipos.js' %}"></script>
<script>
    // Animaciones de entrada
    document.addEventListener('DOMContentLoaded', function() {
        const cards = document.querySelectorAll('.animate-in');
        
        const observer = new IntersectionObserver((entries) => {
            entries.forEach((entry, index) => {
                if (entry.isIntersecting) {
                    setTimeout(() => {
                        entry.target.style.opacity = '1';
                        entry.target.style.transform = 'translateY(0)';
                    }, index * 100);
                }
            });
        });
        
        cards.forEach(card => {
            card.style.opacity = '0';
            card.style.transform = 'translateY(30px)';
            card.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
            observer.observe(card);
        });
    });
</script>
{% endblock %}