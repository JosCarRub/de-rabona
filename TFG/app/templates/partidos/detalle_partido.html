{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}{{ titulo_pagina|default:"Detalles del Partido" }} - De Rabona{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/partidos/detalle_partido_styles.css' %}">
{% endblock %}

{% block content %}
<div class="detalle-partido-container">
    {% if messages %}
        <div class="messages-container">
            {% for message in messages %}
                <div class="custom-alert alert-{{ message.tags }}" role="alert">
                    <div class="alert-icon">
                        {% if message.tags == 'success' %}<i class="fas fa-check-circle"></i>
                        {% elif message.tags == 'error' or message.tags == 'danger' %}<i class="fas fa-exclamation-triangle"></i>
                        {% elif message.tags == 'warning' %}<i class="fas fa-exclamation-circle"></i>
                        {% else %}<i class="fas fa-info-circle"></i>
                        {% endif %}
                    </div>
                    <div class="alert-content">{{ message }}</div>
                    <button type="button" class="alert-dismiss" onclick="this.parentElement.remove()"><i class="fas fa-times"></i></button>
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <main class="partido-main-grid">
        <!-- =================================== -->
        <!-- === COLUMNA IZQUIERDA (SIDEBAR) === -->
        <!-- =================================== -->
        <aside class="partido-sidebar">
            <!-- Tarjeta de Información del Partido -->
            <div class="partido-info-card">
                <div class="partido-info-header">
                    <h1 class="partido-nombre">{{ partido }}</h1>
                    <div class="status-badge status-{{ partido.estado|lower }}">
                        {% if partido.estado == 'PROGRAMADO' %}<i class="fas fa-clock"></i>
                        {% elif partido.estado == 'FINALIZADO' %}<i class="fas fa-check-circle"></i>
                        {% elif partido.estado == 'EN_CURSO' %}<i class="fas fa-play-circle"></i>
                        {% else %}<i class="fas fa-calendar"></i>
                        {% endif %}
                        <span>{{ partido.get_estado_display }}</span>
                    </div>
                </div>
                <div class="partido-info-body">
                    <div class="info-grid">
                        <div class="info-item"><div class="info-icon"><i class="fas fa-futbol"></i></div><div class="info-content"><span class="info-label">Cancha </span><span class="info-value">{{ partido.cancha.nombre_cancha }}</span></div></div>
                        <div class="info-item"><div class="info-icon"><i class="fas fa-map-marker-alt"></i></div><div class="info-content"><span class="info-label">Ubicación </span><span class="info-value">{{ partido.cancha.ubicacion }}</span></div></div>
                        <div class="info-item"><div class="info-icon"><i class="fas fa-calendar-alt"></i></div><div class="info-content"><span class="info-label">Hora </span><span class="info-value">{{ partido.fecha|date:"H:i" }}</span></div></div>
                        <div class="info-item"><div class="info-icon"><i class="fas fa-users"></i></div><div class="info-content"><span class="info-label">Formato </span><span class="info-value">{{ partido.get_tipo_display }}</span></div></div>
                        <div class="info-item"><div class="info-icon"><i class="fas fa-euro-sign"></i></div><div class="info-content"><span class="info-label">Costo </span><span class="info-value">{% if partido.costo > 0 %}{{ partido.costo|floatformat:2 }}€{% else %}Gratis{% endif %}</span></div></div>
                    </div>
                    {% if partido.comentarios %}
                        <div class="comentarios-section"><h4 class="comentarios-title"><i class="fas fa-comment me-2"></i>Comentarios</h4><p class="comentarios-content">{{ partido.comentarios|linebreaksbr }}</p></div>
                    {% endif %}
                </div>
            </div>

            <!-- Tarjeta de Estado del Partido -->
            <div class="partido-estado-card">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-users me-2"></i>Estado del Partido</h3>
                    <div class="players-count"><span class="current">{{ partido.jugadores.count }}</span><span class="separator">/</span><span class="max">{{ partido.max_jugadores }}</span></div>
                </div>
                <div class="card-body">
                    {% widthratio partido.jugadores.count partido.max_jugadores 100 as progress_width %}
                    <div class="progress-container"><div class="progress-bar-container"><div class="progress-fill" style="width: {{ progress_width }}%;"></div></div><div class="progress-labels"><span>{{ plazas_disponibles }} plaza{{ plazas_disponibles|pluralize }} disponible{{ plazas_disponibles|pluralize }}</span></div></div>
                    {% if plazas_disponibles > 0 and inscripcion_esta_abierta %}<div class="status-message status-available"><i class="fas fa-check-circle me-2"></i>¡Inscripciones abiertas!</div>
                    {% elif partido.jugadores.count >= partido.max_jugadores and not partido.es_reto_de_equipo %}<div class="status-message status-full"><i class="fas fa-times-circle me-2"></i>Partido completo</div>
                    {% elif not inscripcion_esta_abierta %}<div class="status-message status-closed"><i class="fas fa-hourglass-end me-2"></i>Inscripciones cerradas</div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Botones de Acción -->
            <div class="action-buttons">
                {% if es_creador and partido.estado == 'PROGRAMADO' %}
                    {% if partido.equipo_local and partido.equipo_visitante %}
                        <a href="{% url 'registrar_resultado_partido' pk=partido.id_partido %}" class="btn btn-primary"><i class="fas fa-clipboard-check me-2"></i>Registrar Resultado</a>
                    {% endif %}
                {% elif not esta_inscrito and inscripcion_esta_abierta and partido.es_partido_abierto %}
                    <form action="{% url 'inscribirse_partido' partido_id=partido.id_partido %}" method="post" class="join-form">{% csrf_token %}<button type="submit" class="btn btn-success" id="joinMatchBtn"><i class="fas fa-plus-circle me-2"></i>Unirse al Partido</button></form>
                {% elif esta_inscrito and partido.es_partido_abierto %}
                    <button class="btn btn-secondary" id="leaveMatchBtn"><i class="fas fa-minus-circle me-2"></i>Abandonar Partido</button>
                {% endif %}
                <a href="{% url 'buscar_partidos' %}" class="btn btn-secondary"><i class="fas fa-arrow-left me-2"></i>Volver a Partidos</a>
            </div>
        </aside>

        <!-- =================================== -->
        <!-- === CONTENIDO PRINCIPAL DINÁMICO === -->
        <!-- =================================== -->
        <section class="partido-main-content">
            
            {% if partido.es_reto_de_equipo %}
                {# ========================================== #}
                {# === VISTA PARA UN RETO DE EQUIPO (CLUB) === #}
                {# ========================================== #}
                <div class="team-management-section">
                    <div class="section-header">
                        <h3 class="section-title"><i class="fas fa-shield-alt me-2"></i>Reto de Equipo</h3>
                    </div>

                    {% if partido.esta_esperando_rival %}
                        {# --- Si el reto está abierto --- #}
                        {% if es_creador %}
                            <div class="solicitudes-card">
                                <div class="card-header"><h3 class="card-title"><i class="fas fa-user-clock me-2"></i>Equipos que han solicitado unirse</h3></div>
                                <div class="card-body">
                                    {% if solicitudes_de_equipos %}
                                        <div class="requests-list">
                                            {% for inscripcion in solicitudes_de_equipos %}
                                            <div class="request-item">
                                                <div class="request-info">
                                                    <h4 class="player-name">{{ inscripcion.equipo.nombre_equipo }}</h4>
                                                </div>
                                                <div class="request-actions">
                                                    <form action="{% url 'aceptar_reto' pk=partido.id_partido inscripcion_id=inscripcion.id %}" method="post">
                                                        {% csrf_token %}
                                                        <button type="submit" class="btn btn-success btn-sm">Aceptar</button>
                                                    </form>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    {% else %}
                                        <div class="empty-state"><div class="empty-icon"><i class="fas fa-hourglass-half"></i></div><h4 class="empty-title">Esperando rivales</h4><p class="empty-desc">Aún no hay equipos que hayan solicitado unirse a tu reto.</p></div>
                                    {% endif %}
                                </div>
                            </div>
                        {% elif equipos_capitaneados %}
                            <div class="solicitudes-card">
                                <div class="card-header"><h3 class="card-title"><i class="fas fa-handshake me-2"></i>Aceptar el Reto</h3></div>
                                <div class="card-body">
                                    <p>Puedes aceptar este reto con uno de tus equipos:</p>
                                    <form action="{% url 'solicitar_unirse_reto' pk=partido.id_partido %}" method="post">
                                        {% csrf_token %}
                                        <select name="equipo_id" class="form-select bg-dark text-white mb-3">
                                            {% for equipo in equipos_capitaneados %}
                                            <option value="{{ equipo.id_equipo }}">{{ equipo.nombre_equipo }}</option>
                                            {% endfor %}
                                        </select>
                                        <button type="submit" class="btn btn-primary w-100">Aceptar Reto con Equipo Seleccionado</button>
                                    </form>
                                </div>
                            </div>
                        {% else %}
                             <div class="empty-state"><div class="empty-icon"><i class="fas fa-info-circle"></i></div><h4 class="empty-title">Reto Abierto</h4><p class="empty-desc">Este equipo está buscando un rival. Si eres capitán de un equipo, podrás aceptar el desafío.</p></div>
                        {% endif %}
                    {% else %}
                        {# --- Si el reto ya está confirmado --- #}
                        <div class="empty-state"><div class="empty-icon"><i class="fas fa-check-circle text-success"></i></div><h4 class="empty-title">¡Reto Aceptado!</h4><p class="empty-desc">Este reto ya ha sido aceptado por <strong>{{ partido.equipo_visitante.nombre_equipo }}</strong>.</p></div>
                    {% endif %}
                </div>

            {% else %}
                {# ======================================= #}
                {# === VISTA PARA UN PARTIDO ABIERTO    === #}
                {# ======================================= #}
                {% if es_creador and partido.estado == 'PROGRAMADO' %}
                    <div class="gestion-equipos-container">
                        <div class="solicitudes-card">
                            <div class="card-header"><h3 class="card-title"><i class="fas fa-user-clock me-2"></i>Solicitudes Pendientes</h3>{% if inscripciones_pendientes %}<div class="members-count">{{ inscripciones_pendientes|length }}</div>{% endif %}</div>
                            <div class="card-body">
                                {% if inscripciones_pendientes %}
                                    <div class="requests-list">
                                        {% for inscripcion in inscripciones_pendientes %}
                                            <div class="request-item">
                                                <div class="request-info"><img src="{{ inscripcion.get_avatar_url }}" alt="{{ inscripcion.jugador.nombre }}" class="player-avatar"><div class="player-details"><h4 class="player-name">{{ inscripcion.jugador.nombre }}</h4><p class="player-position">{{ inscripcion.jugador.get_posicion_display|default:"Jugador" }}</p></div></div>
                                                <div class="request-actions"><form action="{% url 'aceptar_inscripcion' pk=partido.id_partido inscripcion_id=inscripcion.id %}" method="post">{% csrf_token %}<button type="submit" class="btn btn-success btn-sm"><i class="fas fa-check"></i></button></form><form action="{% url 'rechazar_inscripcion' pk=partido.id_partido inscripcion_id=inscripcion.id %}" method="post">{% csrf_token %}<button type="submit" class="btn btn-secondary btn-sm"><i class="fas fa-times"></i></button></form></div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                {% else %}
                                    <div class="empty-state"><div class="empty-icon"><i class="fas fa-user-check"></i></div><h4 class="empty-title">Sin solicitudes</h4><p class="empty-desc">No hay jugadores esperando aprobación.</p></div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- SECCIÓN DE GESTIÓN DE EQUIPOS PARA PARTIDOS ABIERTOS -->
                        <div class="team-management-section">
                            <div class="section-header">
                                <h3 class="section-title"><i class="fas fa-sitemap me-2"></i>Asignación de Equipos</h3>
                                <div class="header-controls">
                                    <div class="assignment-mode-toggle"><button class="mode-btn active" data-mode="drag" id="dragModeBtn"><i class="fas fa-hand-rock"></i></button><button class="mode-btn" data-mode="dropdown" id="dropdownModeBtn"><i class="fas fa-list"></i></button><button class="mode-btn" data-mode="auto" id="autoModeBtn"><i class="fas fa-magic"></i></button></div>
                                    <button class="btn btn-primary" id="saveTeamsBtn" disabled><i class="fas fa-save me-2"></i>Guardar</button>
                                </div>
                            </div>
                            <div class="assignment-info"><div class="info-card drag-info active" data-info="drag"><i class="fas fa-info-circle me-2"></i>Arrastra jugadores entre las zonas.</div><div class="info-card dropdown-info" data-info="dropdown"><i class="fas fa-info-circle me-2"></i>Usa las listas para asignar equipos.</div><div class="info-card auto-info" data-info="auto"><i class="fas fa-info-circle me-2"></i>Asigna equipos de forma automática.</div></div>
                            
                            <div class="assignment-mode drag-mode active" data-assignment="drag">
                                <div class="football-field-container">
                                    <div class="football-field" data-tipo-partido="{{ partido.get_tipo_display }}">
                                        <div class="field-lines"><div class="center-circle"></div><div class="center-line"></div><div class="penalty-area left"></div><div class="penalty-area right"></div></div>
                                        <div class="team-zone local-zone" data-team="local"><div class="team-label">Equipo Local <span class="team-counter local-counter">0</span></div><div class="players-drop-zone" id="local-players">{% if partido.equipo_local %}{% for jugador in partido.equipo_local.jugadores.all %}<div class="field-player local-player" draggable="true" data-jugador-id="{{ jugador.id }}"><img src="{{ user.get_avatar_url }}"alt="{{ jugador.nombre }}" class="player-avatar"><div class="player-name">{{ jugador.nombre|truncatechars:10 }}</div></div>{% endfor %}{% endif %}</div></div>
                                        <div class="team-zone visitante-zone" data-team="visitante"><div class="team-label">Equipo Visitante <span class="team-counter visitante-counter">0</span></div><div class="players-drop-zone" id="visitante-players">{% if partido.equipo_visitante %}{% for jugador in partido.equipo_visitante.jugadores.all %}<div class="field-player visitante-player" draggable="true" data-jugador-id="{{ jugador.id }}"><img src="{{ user.get_avatar_url }}" alt="{{ jugador.nombre }}" class="player-avatar"><div class="player-name">{{ jugador.nombre|truncatechars:10 }}</div></div>{% endfor %}{% endif %}</div></div>
                                    </div>
                                    <div class="bench-area"><h4 class="bench-title"><i class="fas fa-chair me-2"></i>Banquillo / Sin Asignar <span class="team-counter bench-counter">0</span></h4><div class="bench-players" id="bench-players">{% for jugador in jugadores_inscritos_list %}{% if not partido.equipo_local or jugador not in partido.equipo_local.jugadores.all %}{% if not partido.equipo_visitante or jugador not in partido.equipo_visitante.jugadores.all %}<div class="bench-player" draggable="true" data-jugador-id="{{ jugador.id }}">
                                        <img src="{% if jugador.imagen_perfil %}{{ jugador.imagen_perfil.url }}{% else %}{{user.get_avatar_url }} {% endif %}" alt="{{ jugador.nombre }}" class="player-avatar"><div class="player-info"><div class="player-name">{{ jugador.nombre }}</div><div class="player-position">{{ jugador.get_posicion_display|default:"Jugador" }}</div></div>{% if jugador == partido.creador %}<div class="creator-badge"><i class="fas fa-crown"></i></div>{% endif %}</div>{% endif %}{% endif %}{% endfor %}</div></div>
                                </div>
                            </div>

                            <div class="assignment-mode dropdown-mode" data-assignment="dropdown">
                                <div class="dropdown-assignment-container">
                                    <div class="players-assignment-list">{% for jugador in jugadores_inscritos_list %}<div class="player-assignment-row" data-jugador-id="{{ jugador.id }}"><div class="player-info-section"><img src="{{ user.get_avatar_url }}" alt="{{ jugador.nombre }}" class="player-avatar"><div class="player-details"><h4 class="player-name">{{ jugador.nombre }}</h4><p class="player-position">{{ jugador.get_posicion_display|default:"Jugador" }}</p>{% if jugador == partido.creador %}<span class="creator-tag"><i class="fas fa-crown me-1"></i>Creador</span>{% endif %}</div></div><div class="assignment-controls"><select class="team-select" data-jugador-id="{{ jugador.id }}"><option value="bench" {% if not partido.equipo_local or jugador not in partido.equipo_local.jugadores.all %}{% if not partido.equipo_visitante or jugador not in partido.equipo_visitante.jugadores.all %}selected{% endif %}{% endif %}>Banquillo</option><option value="local" {% if partido.equipo_local and jugador in partido.equipo_local.jugadores.all %}selected{% endif %}>Equipo Local</option><option value="visitante" {% if partido.equipo_visitante and jugador in partido.equipo_visitante.jugadores.all %}selected{% endif %}>Equipo Visitante</option></select></div></div>{% endfor %}</div>
                                    <div class="team-summary"><div class="summary-card"><h4 class="summary-title"><i class="fas fa-home me-2"></i>Equipo Local</h4><div class="player-count"><span class="count" id="localCountDropdown">0</span></div><div class="players-preview" id="localPlayersPreview"></div></div><div class="summary-card"><h4 class="summary-title"><i class="fas fa-plane me-2"></i>Equipo Visitante</h4><div class="player-count"><span class="count" id="visitanteCountDropdown">0</span></div><div class="players-preview" id="visitantePlayersPreview"></div></div><div class="summary-card"><h4 class="summary-title"><i class="fas fa-chair me-2"></i>Banquillo</h4><div class="player-count"><span class="count" id="benchCountDropdown">0</span></div><div class="players-preview" id="benchPlayersPreview"></div></div></div>
                                </div>
                            </div>

                            <div class="assignment-mode auto-mode" data-assignment="auto">
                                <div class="auto-assignment-container"><h4 class="auto-title">Asignación Automática</h4><div class="auto-controls"><label class="auto-option"><input type="radio" name="autoMode" value="random" checked><span class="radio-custom"></span><div class="option-content"><strong>Aleatorio</strong><p>Asignación completamente al azar.</p></div></label><button class="btn btn-primary btn-auto-assign" id="autoAssignBtn"><i class="fas fa-magic me-2"></i>Asignar Automáticamente</button></div><div class="auto-result" id="autoResult" style="display: none;"><h4 class="result-title">Resultado</h4><div class="result-teams"><div class="result-team local"><h5><i class="fas fa-home me-2"></i>Equipo Local</h5><div class="result-players" id="autoLocalPlayers"></div></div><div class="result-team visitante"><h5><i class="fas fa-plane me-2"></i>Equipo Visitante</h5><div class="result-players" id="autoVisitantePlayers"></div></div><div class="result-team bench"><h5><i class="fas fa-chair me-2"></i>Banquillo</h5><div class="result-players" id="autoBenchPlayers"></div></div></div></div></div>
                            </div>
                            <form method="post" action="{% url 'detalle_partido' pk=partido.id_partido %}" id="teamAssignmentForm" style="display: none;">{% csrf_token %}<input type="hidden" id="localPlayersInput" name="equipo_local_jugadores" value=""><input type="hidden" id="visitantePlayersInput" name="equipo_visitante_jugadores" value=""></form>
                        </div>
                    </div>
                {% else %}
                    <div class="players-list-section">
                        <div class="section-header"><h3 class="section-title"><i class="fas fa-users me-2"></i>Jugadores Inscritos</h3></div>
                        {% if jugadores_inscritos_list %}
                            <div class="players-grid">
                                {% for jugador_inscrito in jugadores_inscritos_list %}
                                    <div class="player-card">
                                        <div class="player-avatar-wrapper"><img src="{{ user.get_avatar_url }}" class="player-avatar" alt="{{ jugador_inscrito.nombre }}">{% if jugador_inscrito == partido.creador %}<div class="creator-crown"><i class="fas fa-crown"></i></div>{% endif %}</div>
                                        <div class="player-info"><h4 class="player-name">{{ jugador_inscrito.nombre }}</h4><p class="player-position">{{ jugador_inscrito.get_posicion_display|default:"Jugador" }}</p>
                                            <div class="player-badges">
                                                {% if partido.equipo_local and jugador_inscrito in partido.equipo_local.jugadores.all %}<span class="team-badge local">Local</span>
                                                {% elif partido.equipo_visitante and jugador_inscrito in partido.equipo_visitante.jugadores.all %}<span class="team-badge visitante">Visitante</span>
                                                {% else %}<span class="team-badge bench">Banquillo</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="empty-state"><div class="empty-icon"><i class="fas fa-user-plus"></i></div><h4 class="empty-title">Sin jugadores inscritos</h4><p class="empty-desc">Aún no hay jugadores inscritos en este partido.</p></div>
                        {% endif %}
                    </div>
                {% endif %}
            {% endif %}
        </section>
    </main>
</div>

<div id="dragPreview" class="drag-preview"></div>
<div id="touchFeedback" class="touch-feedback"></div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/detalle_partido.js' %}"></script>
<script src="{% static 'js/DragAndDrop_detalle_partido.js' %}"></script>
{% endblock %}