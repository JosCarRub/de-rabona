{% extends 'base.html' %}
{% load static %}

{% block title %}{{ titulo_pagina|default:"Buscar Partidos" }} - De Rabona{% endblock %}

{% block extra_css %}
<link href="{% static 'css/partidos/buscar_partidos_styles.css' %}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="partidos-container" id="buscar-partidos-container">
    <!-- Hero Section -->
    <section class="partidos-hero-section" id="buscar-hero-section">
        <div class="hero-content">
            <div class="hero-icon">
                <i class="fas fa-search"></i>
            </div>
            <div class="hero-text">
                <h1 class="hero-title">{{ titulo_pagina|default:"Partidos Disponibles" }}</h1>
                <p class="hero-subtitle">Asómate a la ventana y busca si están los chavales en las pistas</p>
            </div>
        </div>
        <div class="header-actions">
            <a href="{% url 'crear_partidos' %}" class="btn btn-primary">
                <i class="fas fa-plus"></i>
                <span>Crear Partido</span>
            </a>
        </div>
    </section>

    <!-- Messages -->
    {% if messages %}
        <section class="messages-section" id="buscar-messages-section">
            {% for message in messages %}
                <div class="custom-alert alert-{{ message.tags }}">
                    <div class="alert-icon">
                        {% if message.tags == 'success' %}<i class="fas fa-check-circle"></i>
                        {% elif message.tags == 'error' or message.tags == 'danger' %}<i class="fas fa-exclamation-circle"></i>
                        {% elif message.tags == 'warning' %}<i class="fas fa-exclamation-triangle"></i>
                        {% else %}<i class="fas fa-info-circle"></i>
                        {% endif %}
                    </div>
                    <div class="alert-content">{{ message }}</div>
                    <button class="alert-dismiss" onclick="this.parentElement.remove()"><i class="fas fa-times"></i></button>
                </div>
            {% endfor %}
        </section>
    {% endif %}

    <!-- Partidos Section -->
    <section class="partidos-section" id="buscar-partidos-section">
        <div class="filter-section mb-4">
            <div class="btn-group" role="group" aria-label="Filtros de tipo de partido">
                <a href="{% url 'buscar_partidos' %}" class="btn {% if not request.GET.tipo %}btn-primary{% else %}btn-secondary{% endif %}">Todos</a>
                <a href="?tipo=abierto" class="btn {% if request.GET.tipo == 'abierto' %}btn-primary{% else %}btn-secondary{% endif %}">Partidos Abiertos</a>
                <a href="?tipo=reto" class="btn {% if request.GET.tipo == 'reto' %}btn-primary{% else %}btn-secondary{% endif %}">Retos de Equipo</a>
            </div>
        </div>
        {% if partidos_info_list %}
            <div class="section-header">
                <h2 class="section-title">
                    <i class="fas fa-calendar-alt"></i>
                    Próximos Partidos
                </h2>
                <div class="section-meta">
                    <span class="partidos-count">{{ page_obj.paginator.count }} partido{{ page_obj.paginator.count|pluralize:"s" }}</span>
                </div>
            </div>
            
            <div class="partidos-grid">
                {% for item_info in partidos_info_list %}
                {% with partido=item_info.partido es_creador=item_info.es_creador esta_inscrito=item_info.esta_inscrito inscripcion_esta_abierta=item_info.inscripcion_esta_abierta %}
                <div class="partido-card {% if partido.es_reto_de_equipo %}reto-equipo{% else %}partido-abierto{% endif %}">
                    <!-- Partido Header -->
                    <div class="partido-header">
                        <div class="partido-status">
                            {% if partido.es_reto_de_equipo %}
                                <span class="status-badge status-reto">
                                    <i class="fas fa-shield-alt"></i>
                                    Reto de Equipo
                                </span>
                            {% else %}
                                {% if es_creador %}
                                    <span class="status-badge status-owner"><i class="fas fa-crown"></i> Tu Partido</span>
                                {% elif esta_inscrito %}
                                    <span class="status-badge status-joined"><i class="fas fa-check"></i> Participando</span>
                                {% else %}
                                    <span class="status-badge status-available"><i class="fas fa-clock"></i> Disponible</span>
                                {% endif %}
                            {% endif %}
                        </div>
                        <div class="partido-capacity">
                            <span class="capacity-text">{{ partido.jugadores.count }}/{{ partido.max_jugadores }}</span>
                            <div class="capacity-bar">
                                {% widthratio partido.jugadores.count partido.max_jugadores 100 as progress_width %}
                                <div class="capacity-fill" style="width: {{ progress_width }}%;"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Partido Content -->
                    <div class="partido-content">
                        <h3 class="partido-title">
                            <a href="{% url 'detalle_partido' pk=partido.id_partido %}" class="partido-link">
                                {{ partido.cancha.nombre_cancha }}
                            </a>
                        </h3>
                        <div class="partido-details">
                            <div class="info-item"><div class="info-icon"><i class="fas fa-calendar"></i></div><div class="info-text"><div class="info-label">Fecha y Hora</div><div class="info-value">{{ partido.fecha|date:"d M Y, H:i" }}h</div></div></div>
                            <div class="info-item"><div class="info-icon"><i class="fas fa-clock"></i></div><div class="info-text"><div class="info-label">Límite Inscripción</div><div class="info-value">{{ partido.fecha_limite_inscripcion_efectiva|date:"d/m H:i" }}h</div></div></div>
                            <div class="info-item"><div class="info-icon"><i class="fas fa-map-marker-alt"></i></div><div class="info-text"><div class="info-label">Ubicación</div><div class="info-value">{{ partido.cancha.ubicacion }}</div></div></div>
                            <div class="info-item"><div class="info-icon"><i class="fas fa-futbol"></i></div><div class="info-text"><div class="info-label">Modalidad</div><div class="info-value">{{ partido.get_tipo_display }}</div></div></div>
                            <div class="info-item"><div class="info-icon"><i class="fas fa-signal"></i></div><div class="info-text"><div class="info-label">Nivel</div><div class="info-value">{{ partido.get_nivel_display|default:"Abierto" }}</div></div></div>
                        </div>
                    </div>
                    
                    <!-- Partido Actions -->
                    <div class="partido-actions">
                        {% if partido.es_reto_de_equipo %}
                            <a href="{% url 'detalle_partido' pk=partido.id_partido %}" class="btn btn-primary">
                                <i class="fas fa-eye"></i>
                                <span>Ver Reto</span>
                            </a>
                        {% else %}
                            {% if es_creador %}
                                <a href="{% url 'detalle_partido' pk=partido.id_partido %}" class="btn btn-primary">
                                    <i class="fas fa-cog"></i>
                                    <span>Gestionar</span>
                                </a>
                            {% elif esta_inscrito %}
                                <a href="{% url 'detalle_partido' pk=partido.id_partido %}" class="btn btn-secondary">
                                    <i class="fas fa-eye"></i>
                                    <span>Ver Detalles</span>
                                </a>
                            {% elif inscripcion_esta_abierta %}
                                <form action="{% url 'inscribirse_partido' partido_id=partido.id_partido %}" method="post" class="join-form">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-user-plus"></i>
                                        <span>Unirse</span>
                                    </button>
                                </form>
                            {% else %}
                                <div class="btn btn-disabled">
                                    <i class="fas fa-ban"></i>
                                    <span>No Disponible</span>
                                </div>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
                {% endwith %}
                {% endfor %}
            </div>
            
            <!-- Pagination -->
            {% if is_paginated %}
                <nav class="pagination-section" id="buscar-pagination">
                    <div class="pagination-content">
                        {% if page_obj.has_previous %}
                            <a href="?page=1{% if request.GET.tipo %}&tipo={{ request.GET.tipo }}{% endif %}" class="page-link">
                                <i class="fas fa-angle-double-left"></i>
                                <span>Primera</span>
                            </a>
                            <a href="?page={{ page_obj.previous_page_number }}{% if request.GET.tipo %}&tipo={{ request.GET.tipo }}{% endif %}" class="page-link">
                                <i class="fas fa-angle-left"></i>
                                <span>Anterior</span>
                            </a>
                        {% endif %}
                        
                        <div class="page-info">
                            <span class="current-page">{{ page_obj.number }}</span>
                            <span class="page-separator">de</span>
                            <span class="total-pages">{{ page_obj.paginator.num_pages }}</span>
                        </div>
                        
                        {% if page_obj.has_next %}
                            <a href="?page={{ page_obj.next_page_number }}{% if request.GET.tipo %}&tipo={{ request.GET.tipo }}{% endif %}" class="page-link">
                                <span>Siguiente</span>
                                <i class="fas fa-angle-right"></i>
                            </a>
                            <a href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.tipo %}&tipo={{ request.GET.tipo }}{% endif %}" class="page-link">
                                <span>Última</span>
                                <i class="fas fa-angle-double-right"></i>
                            </a>
                        {% endif %}
                    </div>
                </nav>
            {% endif %}
        {% else %}
            <!-- Empty State -->
            <div class="empty-state">
                <div class="empty-icon"><i class="fas fa-search"></i></div>
                <div class="empty-content">
                    <h3 class="empty-title">No se encontraron partidos</h3>
                    <p class="empty-desc">No hay partidos disponibles que coincidan con tus criterios actuales. ¿Por qué no crear el primero?</p>
                    <div class="empty-actions">
                        <a href="{% url 'crear_partidos' %}" class="btn btn-primary"><i class="fas fa-plus"></i><span>Crear Primer Partido</span></a>
                        <a href="{% url 'buscar_partidos' %}" class="btn btn-secondary"><i class="fas fa-sync-alt"></i><span>Actualizar Búsqueda</span></a>
                    </div>
                </div>
            </div>
        {% endif %}
    </section>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Animaciones de entrada
    const observerOptions = {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
    };

    const observer = new IntersectionObserver((entries) => {
        entries.forEach((entry, index) => {
            if (entry.isIntersecting) {
                setTimeout(() => {
                    entry.target.classList.add('animate-in');
                }, index * 100);
                observer.unobserve(entry.target);
            }
        });
    }, observerOptions);

    // Observar cards
    document.querySelectorAll('.partido-card').forEach(card => {
        observer.observe(card);
    });

    // Confirmación de inscripción
    document.querySelectorAll('.join-form').forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const confirmation = confirm('¿Confirmas tu participación en este partido?');
            
            if (confirmation) {
                const button = this.querySelector('.btn');
                const originalContent = button.innerHTML;
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>Inscribiendo...</span>';
                button.disabled = true;
                
                setTimeout(() => {
                    this.submit();
                }, 500);
            }
        });
    });

    // Auto-dismiss alerts
    setTimeout(() => {
        document.querySelectorAll('.custom-alert').forEach(alert => {
            alert.style.opacity = '0';
            alert.style.transform = 'translateY(-10px)';
            setTimeout(() => alert.remove(), 300);
        });
    }, 5000);
});
</script>
{% endblock %}