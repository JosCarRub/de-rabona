{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Special Admin Dashboard </title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="{% static 'css/secret.css'  %}" rel="stylesheet">
    <link rel="icon" href="{% static 'favicon.svg' %}" type="image/svg+xml">

</head>
<body>
    <!-- Launch Screen -->
    <div class="launch-screen" id="launchScreen">
        <div class="welcome-content">
            <div class="ai-logo">
                <i class="fas fa-brain"></i>
            </div>
            <h1 class="welcome-title">Dashboard</h1>
            <p class="welcome-subtitle">Centro de comando administrativo avanzado</p>
            <button class="launch-button" id="launchButton">
                <i class="fas fa-rocket me-2"></i>
                Entrar al Dashboard
            </button>
        </div>
        <a href="{% url 'home' %}" class="nav-link">
                <button class="launch-button" >
                    <i class="fas fa-arrow-left"></i>
                    Volver a la aplicaci√≥n
                </button>
            </a>
    </div>

    <!-- Animation Screen -->
    <div class="animation-screen" id="animationScreen">
        <canvas id="matrix-canvas"></canvas>
        <div class="loading-logo">
            <i class="fas fa-brain"></i>
        </div>
        <div class="loading-text">Inicializando Admin Dashboard</div>
        <div class="loading-progress">
            <div class="loading-bar"></div>
        </div>
    </div>

    <!-- Main App -->
    <div class="main-app" id="mainApp">
        <!-- Background Effects -->
        <div class="bg-effects">
            <div class="grid-overlay"></div>
            <div class="glow-orb orb1"></div>
            <div class="glow-orb orb2"></div>
        </div>

        <!-- Mobile Menu Button -->
        <button class="mobile-menu-btn" id="mobileMenuBtn">
            <i class="fas fa-bars"></i>
        </button>

        <!-- Futuristic Sidebar -->
        <aside class="sidebar" id="sidebar">
            <!-- Brand Section -->
            <div class="brand-section">
                <div class="brand">
                    <div class="brand-icon">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div>
                        <div class="brand-text">IA Dashboard</div>
                        <div class="brand-subtitle">Admin Portal</div>
                    </div>
                </div>
            </div>

            <!-- Navigation -->
            <nav class="nav-section">
                <div class="nav-item">
                    <a href="#" class="nav-link active">
                        <i class="fas fa-robot nav-icon"></i>
                        <span>Asistente IA</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="{% url 'perfil' %}" class="nav-link" id="backToApp">
                        <i class="fas fa-arrow-left nav-icon"></i>
                        <span>Volver a la App</span>
                    </a>
                </div>

                <div class="nav-item">
                    <a href="{% url 'dashboard_voice' %}" class="nav-link" id="backToApp">
                        <i class="fas fa-comments"></i>
                        <span>Dashboard Voice</span>
                    </a>
                </div>
                
            </nav>

            <!-- Status Section -->
            <div class="status-section">
                <div class="status-card">
                    <div class="status-indicator">
                        <div class="status-dot" id="statusDot"></div>
                        <span id="statusText">Sistema Activo</span>
                    </div>
                    <div class="status-text">Todos los servicios operativos</div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="content-container">
                <div class="chat-interface">
                    <!-- Chat Header -->
                    <div class="chat-header">
                        <h1 class="chat-title">Asistente IA Administrativo</h1>
                        <p class="chat-description">Tu copiloto inteligente para la gesti√≥n de la aplicaci√≥n</p>
                    </div>
                    
                    <!-- Messages -->
                    <div class="messages-container" id="messagesContainer">
                        <div class="message ai">
                            <div class="avatar ai">
                                <i class="fas fa-brain"></i>
                            </div>
                            <div class="message-bubble">
                                Bienvenido al centro de comando administrativo. Soy tu asistente IA especializado en an√°lisis de datos, ¬øC√≥mo puedo potenciar tu gesti√≥n hoy?
                            </div>
                        </div>
                    </div>

                    <!-- Input Area -->
                    <div class="input-area">
                        <div class="input-container">
                            <textarea 
                                class="message-input" 
                                id="messageInput"
                                placeholder="Escribe tu consulta o comando..."
                                rows="1"
                            ></textarea>
                            <button class="send-button" id="sendButton">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>

        // ruta relativa que ser√° interceptada por Nginx
        const AI_ENDPOINT = '/api/agent/query-database-agent';

        // Estado de la aplicaci√≥n
        let isProcessing = false;
        let isVoiceEnabled = false;
        let speechSynthesis = null;
        let currentUtterance = null;

        // Inicializar Text-to-Speech
        function initializeTextToSpeech() {
            if ('speechSynthesis' in window) {
                speechSynthesis = window.speechSynthesis;
                isVoiceEnabled = true;
                console.log('üîä Text-to-Speech disponible');
                
                // Esperar a que se carguen las voces
                if (speechSynthesis.getVoices().length === 0) {
                    speechSynthesis.addEventListener('voiceschanged', () => {
                        console.log('üîä Voces cargadas:', speechSynthesis.getVoices().length);
                    });
                }
            } else {
                console.log('‚ùå Text-to-Speech no disponible en este navegador');
            }
        }

        // Funci√≥n para leer texto en voz alta
        function speakText(text) {
            if (!isVoiceEnabled || !speechSynthesis) {
                console.log('‚ùå Voz no disponible');
                return;
            }

            // Detener cualquier reproducci√≥n anterior
            speechSynthesis.cancel();

            // Limpiar texto de HTML y markdown
            const cleanText = text
                .replace(/<[^>]*>/g, '') // Remover HTML
                .replace(/\*\*(.*?)\*\*/g, '$1') // Remover markdown bold
                .replace(/\*(.*?)\*/g, '$1') // Remover markdown italic
                .replace(/‚Ä¢/g, '') // Remover vi√±etas
                .trim();

            if (!cleanText) return;

            // Crear utterance
            currentUtterance = new SpeechSynthesisUtterance(cleanText);
            
            // Configurar voz (buscar voz en espa√±ol)
            const voices = speechSynthesis.getVoices();
            const spanishVoice = voices.find(voice => 
                voice.lang.includes('es') || 
                voice.name.toLowerCase().includes('spanish') ||
                voice.name.toLowerCase().includes('espa√±ol')
            );
            
            if (spanishVoice) {
                currentUtterance.voice = spanishVoice;
                currentUtterance.lang = 'es-ES';
            } else {
                currentUtterance.lang = 'es-ES';
            }

            // Configurar par√°metros de voz
            currentUtterance.rate = 0.9; // Velocidad
            currentUtterance.pitch = 1.0; // Tono
            currentUtterance.volume = 0.8; // Volumen

            // Event listeners
            currentUtterance.onstart = () => {
                console.log('üîä Reproduciendo voz...');
                updateVoiceButton(true);
            };

            currentUtterance.onend = () => {
                console.log('üîä Voz terminada');
                updateVoiceButton(false);
            };

            currentUtterance.onerror = (event) => {
                console.error('‚ùå Error en voz:', event.error);
                updateVoiceButton(false);
            };

            // Reproducir
            speechSynthesis.speak(currentUtterance);
        }

        // Funci√≥n para detener la voz
        function stopSpeech() {
            if (speechSynthesis) {
                speechSynthesis.cancel();
                updateVoiceButton(false);
            }
        }

        // Funci√≥n de animaci√≥n de entrada unificada y elegante
        function initializeElegantEntrance() {
            // Crear pantalla de entrada
            const entranceScreen = document.createElement('div');
            entranceScreen.id = 'elegantEntrance';
            entranceScreen.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: linear-gradient(135deg, #000 0%, #0a0a0a 50%, #000 100%);
                z-index: 10000;
                opacity: 1;
                display: flex;
                align-items: center;
                justify-content: center;
                overflow: hidden;
            `;

            // Crear contenedor principal del logo
            const logoContainer = document.createElement('div');
            logoContainer.style.cssText = `
                text-align: center;
                opacity: 0;
                transform: scale(0.8) translateY(20px);
                animation: elegantEntry 2s ease-out 0.3s forwards;
            `;

            // Crear icono del cerebro
            const brainIcon = document.createElement('div');
            brainIcon.innerHTML = '<i class="fas fa-brain"></i>';
            brainIcon.style.cssText = `
                font-size: 4rem;
                color: #00d4b1;
                margin-bottom: 1rem;
                filter: drop-shadow(0 0 20px rgba(0, 212, 177, 0.5));
                animation: pulse 2s ease-in-out infinite;
            `;

            // Crear texto del t√≠tulo
            const titleText = document.createElement('div');
            titleText.textContent = 'AI Assistant';
            titleText.style.cssText = `
                font-size: 2.5rem;
                font-weight: bold;
                color: #ffffff;
                font-family: Arial, sans-serif;
                letter-spacing: 2px;
                margin-bottom: 0.5rem;
                text-shadow: 0 0 30px rgba(0, 212, 177, 0.3);
            `;

            // Crear l√≠nea decorativa
            const decorativeLine = document.createElement('div');
            decorativeLine.style.cssText = `
                width: 0;
                height: 2px;
                background: linear-gradient(90deg, transparent, #00d4b1, transparent);
                margin: 1rem auto;
                animation: lineExpand 1.5s ease-out 1s forwards;
                box-shadow: 0 0 10px rgba(0, 212, 177, 0.8);
            `;

            // Crear part√≠culas de fondo
            const particlesContainer = document.createElement('div');
            particlesContainer.style.cssText = `
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                pointer-events: none;
            `;

            // Generar part√≠culas flotantes
            for (let i = 0; i < 20; i++) {
                const particle = document.createElement('div');
                const size = Math.random() * 4 + 2;
                const duration = Math.random() * 3 + 2;
                const delay = Math.random() * 2;
                
                particle.style.cssText = `
                    position: absolute;
                    width: ${size}px;
                    height: ${size}px;
                    background: rgba(0, 212, 177, 0.6);
                    border-radius: 50%;
                    left: ${Math.random() * 100}%;
                    top: ${Math.random() * 100}%;
                    animation: float ${duration}s ease-in-out ${delay}s infinite;
                    box-shadow: 0 0 10px rgba(0, 212, 177, 0.8);
                `;
                particlesContainer.appendChild(particle);
            }

            // Agregar estilos CSS para las animaciones
            const styleSheet = document.createElement('style');
            styleSheet.textContent = `
                @keyframes elegantEntry {
                    0% {
                        opacity: 0;
                        transform: scale(0.8) translateY(20px);
                    }
                    60% {
                        opacity: 1;
                        transform: scale(1.05) translateY(-5px);
                    }
                    100% {
                        opacity: 1;
                        transform: scale(1) translateY(0);
                    }
                }

                @keyframes pulse {
                    0%, 100% {
                        transform: scale(1);
                        filter: drop-shadow(0 0 20px rgba(0, 212, 177, 0.5));
                    }
                    50% {
                        transform: scale(1.1);
                        filter: drop-shadow(0 0 30px rgba(0, 212, 177, 0.8));
                    }
                }

                @keyframes lineExpand {
                    0% {
                        width: 0;
                    }
                    100% {
                        width: 200px;
                    }
                }

                @keyframes float {
                    0%, 100% {
                        transform: translateY(0) rotate(0deg);
                        opacity: 0.6;
                    }
                    50% {
                        transform: translateY(-20px) rotate(180deg);
                        opacity: 1;
                    }
                }

                @keyframes fadeOutEntrance {
                    0% {
                        opacity: 1;
                        transform: scale(1);
                    }
                    100% {
                        opacity: 0;
                        transform: scale(1.1);
                    }
                }

                .typing-indicator {
                    display: inline-block;
                    position: relative;
                }

                .typing-indicator span {
                    display: inline-block;
                    background-color: #00d4b1;
                    width: 8px;
                    height: 8px;
                    border-radius: 50%;
                    margin: 0 2px;
                    animation: typing 1.4s infinite ease-in-out;
                }

                .typing-indicator span:nth-child(2) {
                    animation-delay: 0.2s;
                }

                .typing-indicator span:nth-child(3) {
                    animation-delay: 0.4s;
                }

                @keyframes typing {
                    0%, 60%, 100% {
                        transform: translateY(0);
                        opacity: 0.5;
                    }
                    30% {
                        transform: translateY(-10px);
                        opacity: 1;
                    }
                }

                .send-button:disabled {
                    opacity: 0.6;
                    cursor: not-allowed;
                }

                .message-input:disabled {
                    opacity: 0.8;
                    background-color: rgba(255, 255, 255, 0.05);
                }
            `;
            document.head.appendChild(styleSheet);

            // Ensamblar elementos
            logoContainer.appendChild(brainIcon);
            logoContainer.appendChild(titleText);
            logoContainer.appendChild(decorativeLine);
            
            entranceScreen.appendChild(particlesContainer);
            entranceScreen.appendChild(logoContainer);
            document.body.insertBefore(entranceScreen, document.body.firstChild);

            // Ejecutar secuencia de salida despu√©s de 2.5 segundos
            setTimeout(() => {
                entranceScreen.style.animation = 'fadeOutEntrance 1.2s ease-out forwards';
                entranceScreen.style.pointerEvents = 'none';
                
                // Remover elemento despu√©s del fade out
                setTimeout(() => {
                    if (entranceScreen.parentNode) {
                        entranceScreen.parentNode.removeChild(entranceScreen);
                    }
                }, 1200);
            }, 2500);
        }

        // Matrix Animation Class optimizada
        class AIPixel {
            constructor(x, y, color, speed, delay, step, boundSize) {
                this.x = x;
                this.y = y;
                this.color = color;
                this.speed = Math.random() * 0.5 + 0.3;
                this.size = 0;
                this.maxSize = Math.random() * 3 + 1;
                this.opacity = 0;
                this.delay = delay;
                this.counter = 0;
                this.step = step;
                this.phase = Math.random() * Math.PI * 2;
                this.glowIntensity = Math.random() * 0.5 + 0.5;
            }

            draw(ctx) {
                if (this.counter < this.delay) {
                    this.counter += this.step;
                    return;
                }

                const pulse = Math.sin(this.phase + Date.now() * 0.003) * 0.3 + 0.7;
                this.opacity = Math.min(pulse * this.glowIntensity, 1);
                
                if (this.size < this.maxSize) {
                    this.size += 0.05;
                }

                ctx.save();
                ctx.globalAlpha = this.opacity * 0.3;
                ctx.fillStyle = this.color;
                ctx.shadowColor = this.color;
                ctx.shadowBlur = 10;
                ctx.fillRect(this.x - 2, this.y - 2, this.size + 4, this.size + 4);
                
                ctx.globalAlpha = this.opacity;
                ctx.shadowBlur = 5;
                ctx.fillRect(this.x, this.y, this.size, this.size);
                ctx.restore();
            }
        }

        // Initialize Matrix Animation optimizada
        function initMatrixAnimation() {
            const canvas = document.getElementById('matrix-canvas');
            if (!canvas) return null;
            
            const ctx = canvas.getContext('2d');
            let pixels = [];
            let animationFrame;

            function resizeCanvas() {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
                initPixels();
            }

            function initPixels() {
                pixels = [];
                const gap = 25;
                const colors = ['#00d4b1', '#00b89f', 'rgba(0, 212, 177, 0.8)', 'rgba(0, 212, 177, 0.6)'];
                
                for (let x = 0; x < canvas.width; x += gap) {
                    for (let y = 0; y < canvas.height; y += gap) {
                        const color = colors[Math.floor(Math.random() * colors.length)];
                        const delay = Math.sqrt((x - canvas.width/2)**2 + (y - canvas.height/2)**2) * 0.5;
                        pixels.push(new AIPixel(x, y, color, 1, delay, 2, 3));
                    }
                }
            }

            function animate() {
                try {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    pixels.forEach(pixel => pixel.draw(ctx));
                    animationFrame = requestAnimationFrame(animate);
                } catch (error) {
                    console.log('Animation stopped');
                }
            }

            try {
                resizeCanvas();
                animate();
            } catch (error) {
                console.log('Matrix animation failed to start');
                return null;
            }

            return () => {
                if (animationFrame) {
                    cancelAnimationFrame(animationFrame);
                }
            };
        }

        // Initialize App Launch Sequence optimizada
        function initializeLaunchSequence() {
            const launchButton = document.getElementById('launchButton');
            const launchScreen = document.getElementById('launchScreen');
            const animationScreen = document.getElementById('animationScreen');
            const mainApp = document.getElementById('mainApp');

            launchButton?.addEventListener('click', function() {
                launchScreen.classList.add('hide');
                
                setTimeout(() => {
                    launchScreen.style.display = 'none';
                    animationScreen.classList.add('show');
                    
                    const stopMatrix = initMatrixAnimation();
                    
                    setTimeout(() => {
                        animationScreen.classList.add('hide');
                        if (stopMatrix) stopMatrix();
                        
                        setTimeout(() => {
                            animationScreen.style.display = 'none';
                            mainApp.classList.add('loaded');
                            setTimeout(() => {
                                const messagesContainer = document.getElementById('messagesContainer');
                                if (messagesContainer) {
                                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                                }
                            }, 1000);
                        }, 1200);
                    }, 3000);
                }, 800);
            });
        }

        // Funciones para el chat con IA
        function addMessage(content, isUser = false) {
            const messagesContainer = document.getElementById('messagesContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'ai'}`;

            if (isUser) {
                messageDiv.innerHTML = `
                    <div class="message-bubble">
                        ${content}
                    </div>
                    <div class="avatar user">
                        <i class="fas fa-user"></i>
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="avatar ai">
                        <i class="fas fa-brain"></i>
                    </div>
                    <div class="message-bubble">
                        ${content}
                        ${isVoiceEnabled ? `
                        <div class="voice-controls">
                            <button class="voice-btn" onclick="speakText('${content.replace(/'/g, "\\'")}')">
                                <i class="fas fa-volume-up"></i>
                            </button>
                            <button class="voice-btn stop-btn" onclick="stopSpeech()" style="display: none;">
                                <i class="fas fa-stop"></i>
                            </button>
                        </div>
                        ` : ''}
                    </div>
                `;
            }

            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function updateVoiceButton(isPlaying) {
            const voiceBtns = document.querySelectorAll('.message:last-child .voice-btn');
            const stopBtns = document.querySelectorAll('.message:last-child .stop-btn');
            
            voiceBtns.forEach(btn => {
                if (!btn.classList.contains('stop-btn')) {
                    btn.style.display = isPlaying ? 'none' : 'inline-block';
                }
            });
            
            stopBtns.forEach(btn => {
                btn.style.display = isPlaying ? 'inline-block' : 'none';
            });
        }

        function addTypingIndicator() {
            const messagesContainer = document.getElementById('messagesContainer');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message ai';
            typingDiv.id = 'typing-indicator';
            typingDiv.innerHTML = `
                <div class="avatar ai">
                    <i class="fas fa-brain"></i>
                </div>
                <div class="message-bubble">
                    <div class="typing-indicator">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            `;
            messagesContainer.appendChild(typingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function removeTypingIndicator() {
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        function updateStatus(status, text) {
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            
            if (statusDot && statusText) {
                statusDot.className = `status-dot ${status}`;
                statusText.textContent = text;
            }
        }

        function formatAIResponse(answer) {
            // Convertir markdown b√°sico a HTML
            let formatted = answer
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/\n\*/g, '<br>‚Ä¢')
                .replace(/\n/g, '<br>');
            
            return formatted;
        }

        async function sendMessageToAI(message) {
            if (isProcessing) return;
            
            isProcessing = true;
            updateStatus('processing', 'Procesando...');
            
            // Agregar mensaje del usuario
            addMessage(message, true);
            
            // Mostrar indicador de escritura
            addTypingIndicator();
            
            // Deshabilitar controles
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');
            messageInput.disabled = true;
            sendButton.disabled = true;

            try {
                const response = await fetch(AI_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        question: message
                    })
                });

                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }

                const data = await response.json();
                
                // Remover indicador de escritura
                removeTypingIndicator();
                
                if (data.error) {
                    addMessage(`‚ùå Error: ${data.error}`, false);
                    updateStatus('error', 'Error en respuesta');
                } else if (data.answer) {
                    const formattedAnswer = formatAIResponse(data.answer);
                    addMessage(formattedAnswer, false);
                    updateStatus('active', 'Sistema Activo');
                    
                    // Reproducir autom√°ticamente la respuesta si est√° habilitado
                    if (isVoiceEnabled) {
                        setTimeout(() => {
                            speakText(data.answer);
                        }, 500);
                    }
                } else {
                    addMessage('‚ùå Respuesta vac√≠a del servidor', false);
                    updateStatus('warning', 'Respuesta incompleta');
                }

            } catch (error) {
                console.error('Error al comunicarse con la IA:', error);
                removeTypingIndicator();
                addMessage(`‚ùå Error de conexi√≥n: ${error.message}`, false);
                updateStatus('error', 'Error de conexi√≥n');
            } finally {
                isProcessing = false;
                messageInput.disabled = false;
                sendButton.disabled = false;
                messageInput.value = '';
                messageInput.focus();
            }
        }

        function initializeChatHandlers() {
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');

            // Manejar env√≠o con bot√≥n
            sendButton.addEventListener('click', function() {
                const message = messageInput.value.trim();
                if (message && !isProcessing) {
                    sendMessageToAI(message);
                }
            });

            // Manejar env√≠o con Enter
            messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    const message = messageInput.value.trim();
                    if (message && !isProcessing) {
                        sendMessageToAI(message);
                    }
                }
            });

            // Auto-resize del textarea
            messageInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 150) + 'px';
            });
        }

        // Initialize everything when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeElegantEntrance();
            initializeLaunchSequence();
            initializeChatHandlers();
            initializeTextToSpeech();
            
            // Mensaje de bienvenida despu√©s de que se cargue la app
            setTimeout(() => {
                updateStatus('active', 'Sistema Activo');
            }, 4000);
        });
    </script>
</body>
</html>